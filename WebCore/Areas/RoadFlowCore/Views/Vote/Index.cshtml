@{
    ViewBag.Title = "Index";
}


    <form method="post" id="form1">
        @Html.AntiForgeryToken()   
        <div class="querybar">
            <table cellpadding="0" cellspacing="1" border="0" width="100%">
                <tr>
                    <td>
                        主题：<input type="text" class="mytext" id="Topic" name="Topic" value="" style="width:200px" />
                        创建时间：<input type="text" class="mycalendar" id="Date1" name="Date1" style="width:90px;" value="" /> 至 <input type="text" class="mycalendar" id="Date2" name="Date2" style="width:90px;" value="" />
                        <input type="button" name="Search" onclick="query();" value="&nbsp;&nbsp;查&nbsp;询&nbsp;&nbsp;" class="mybutton" />
                        <input type="button" onclick="edit();" value="添加问卷" class="mybutton" />
                        <input type="button" onclick="del(this);" value="删除所选" class="mybutton" />
                    </td>
                </tr>
            </table>
        </div>
        <input type="hidden" name="checkbox_app" id="checkbox_app" value="" />
        <table id="listtable"></table>
        <div class="buttondiv"></div>
    </form>
    <script type="text/javascript">
    var dialog = new RoadUI.Window();
    var curPageSize;
    var curPageNumber;
    $(function ()
    {
        $("#listtable").jqGrid({
            url: "Query?@Html.Raw(ViewBag.query)",
            postData: { "__RequestVerificationToken": $("input[name='__RequestVerificationToken']").val() },
            mtype: 'POST',
            datatype: "json",
            colNames: ['主题', '创建时间', '参与人员','结束时间', '状态','操作'],
            colModel: [
                { name: 'Topic', index: 'Topic' },
                { name: 'CreateTime', index: 'CreateTime', align: "left" },
                { name: 'PartakeUsers', index: 'PartakeUsers', align: "left" },
                { name: 'EndTime', index: 'EndTime', align: "left" },
                { name: 'Status', index: 'Status', align: "left", width:80 },
                { name: 'Opation', index: '', sortable: false, title: false, align: "left", width: 120 }
            ],
            sortname: "CreateTime",
            sortorder: "DESC",
            height: '100%',
            multiselect: true,
            width: $(window).width(),

             
            loadComplete: function ()
            {
                 //鼠标移动背景颜色变化
                $("#listtable tr").mouseenter(function () {
                    $(this).css("background", "lightblue");
                });
                $("#listtable tr").mouseleave(function () {
                    $(this).css("background", "white");
                });
                var gridObj = $("#listtable");
                var records = gridObj.getGridParam("userData");
                curPageSize = records.pagesize;
                curPageNumber = records.pagenumber;
                $(".buttondiv").html(RoadUI.Core.getPager1(records.total, records.pagesize, records.pagenumber, "query"));
            }
        });
    });
    $(window).resize(function () {
        $("#listtable").setGridWidth($(window).width());
    });
    function query(size, number) {
        var data = {
            __RequestVerificationToken: $("input[name='__RequestVerificationToken']").val(),
            Topic: $("#Topic").val(), Date1: $("#Date1").val(), Date2: $("#Date2").val(),
            pagesize: size, pagenumber: number
        };
        $("#listtable").setGridParam({ postData: data }).trigger("reloadGrid");
    }
    function edit(id)
    {
        dialog.open({title: (id ? "编辑" : "添加") + "问卷", width: 700, height: 360, url: 'Edit?pagesize=' + curPageSize + "&pagenumber=" + curPageNumber + '&id=' + (id || "") + '&@ViewBag.query' });
    }
    function editOption(id) {
        dialog.open({title: "选题管理", width: 800, height: 500, url: 'EditItem?pagesize=' + curPageSize + "&pagenumber=" + curPageNumber + '&id=' + (id || "") + '&@ViewBag.query' });
    }
    function publish(id, status, a)
    {
        if (!confirm('您确认要' + (status == 1 ? "发布" : "取消发布") + "吗?")) {
            return;
        }
        $.ajax({
            url: "Publish?" + "@Html.Raw(ViewBag.query)" + "&pagesize=" + curPageSize + "&pagenumber=" + curPageNumber,
            data: { "id": id || "", "status": status, "__RequestVerificationToken": $("input[name='__RequestVerificationToken']").val() },
            type: "post",
            success: function (txt)
            {
                alert(txt);
                if (txt.indexOf("成功") >= 0) {
                    query(curPageSize, curPageNumber);
                }
            }
        });
        return true;
    }

    function del(but)
    {
        var rowIds = $("#listtable").jqGrid('getGridParam', 'selarrrow');
        if (rowIds.length==0)
        {
            alert("您没有选择要删除的问卷!");
            return false;
        }
        if (!confirm('您真的要删除所选问卷及其相关数据吗?'))
        {
            return false;
        }
        $(but).prop("disabled", true);
        $.ajax({
            url: "Delete?" + "@Html.Raw(ViewBag.query)" + "&pagesize=" + curPageSize + "&pagenumber=" + curPageNumber,
            data: { "ids": rowIds.join(","), "__RequestVerificationToken": $("input[name='__RequestVerificationToken']").val() },
            type: "post",
            success: function (txt)
            {
                alert(txt);
                $(but).prop("disabled", false);
                query(curPageSize, curPageNumber);
            }
        });
        return true;
    }
    </script>

