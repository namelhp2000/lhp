@{
    ViewBag.Title = "CustomForm1";
}
@model System.Data.DataTable
<form id="form1" method="post">
    <br />
    <table cellpadding="0" cellspacing="1" border="0" width="99%" class="formtable">
        @if (Model.Rows.Count > 0)
        {
            foreach (System.Data.DataRow dr in Model.Rows)
            {
                <tr>
                    <th style="width: 80px;">标题：</th>
                    <td><input type="text" name="Title" id="Title" class="mytext" value="@dr["f1"]" validate="empty" errmsg="标题不能为空!" style="width: 75%" /></td>
                </tr>
                <tr>
                    <th>内容：</th>
                    <td><textarea class="mytextarea" name="Contents" id="Contents" model="html" validate="editor" errmsg="内容不能为空!" style="width: 75%;height:80px;">@Html.Raw(dr["f2"])</textarea></td>
                </tr>
            }
        }
        else
        {
            <tr>

                <th style="width: 80px;">标题：</th>
                <td><input type="text" name="Title" class="mytext" value="" validate="empty" errmsg="标题不能为空!" style="width: 75%" /></td>

            </tr>

            <tr>
                <th>内容：</th>
                <td><textarea class="mytextarea" name="Contents" id="Contents" model="html" validate="editor" errmsg="内容不能为空!" style="width: 75%;height:80px;"> </textarea></td>
            </tr>
        }

    </table>
    <div class="buttondiv">
        <input type="button" class="mybutton" value="保存" onclick="save(this);" />
        <input type="button" class="mybutton" value="退回" onclick="parent.flowBack(true);" />
        <input type="button" class="mybutton" value="发送" onclick="parent.flowSend(true);" />
    </div>
    @Html.AntiForgeryToken()
</form>
<script src="/RoadFlowResources/scripts/ckeditor/ckeditor.js"></script>
<script src="/RoadFlowResources/scripts/flowRun/form.js"></script>
<script>
    $(window).load(function () {
        var editor = CKEDITOR.replace("Contents", {
            height: 200,
            toolbarGroups: formLoad.ckeditor_toolbarFullGroups,
            filebrowserImageUploadUrl: '/RoadFlowCore/Controls/SaveCKEditorFiles'
        });

        //设置流程关联的业务表主键值
        $("#instanceid", parent.document).val("");

        //设置流程标题
        $("#customformtitle", parent.document).val($("#Title").val());

        //$('textarea[name="Contents"]').val("可爱");
        //alert(CKEDITOR.instances.Contents.getData());

    });
    CKEDITOR.on('instanceReady', function (e) {
        parent.setIframeHeight();
    });
    function save(but) {
        var f = document.forms[0];
        if (new RoadUI.Validate().validateForm(f)) {
            var o = RoadUI.Core.serializeForm($(f));
            var contents = CKEDITOR.instances.Contents.getData();
            o.Contents = contents;
            $(but).prop("disabled", true);
            $.ajax({
                url: "SaveCustomForm"+"@Html.Raw(ViewBag.queryString)",
                data: o, type: "post", dataType: "json", success: function (json) {
                    alert(json.message);
                    $(but).prop("disabled", false);
                    if (json.success == 1) {
                        window.location = 'Customform1?@Html.Raw(ViewBag.query)&instanceid=' + json.instanceid;
                    }
                }
            });
        }
    }

</script>

